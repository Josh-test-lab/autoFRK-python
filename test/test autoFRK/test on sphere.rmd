---
title: "AutoFRK"
output: html_notebook
---

```{r}
library(dplyr)
library(autoFRK)
library(reticulate)
np <- import("numpy")
```

```{r}
# Set working directory to the path of the current file
# This requires the 'rstudioapi' package
if (!require("rstudioapi")) {
  install.packages("rstudioapi")
}
setwd(dirname(rstudioapi::getSourceEditorContext()$path))
getwd()
```

```{r}
data_path <- "../../../Weather2K/weather2k.npy"
data <- np$load(data_path) %>% py_to_r()

data <- aperm(data, c(2, 1, 3))
dim(data)
```

```{r}
lat_lon_alt <- t(data[1:3, , 1])
data <- data[-(1:3), , ]
lat_lon_alt %>%
  head() %>%
  print()
```

```{r}
n = 100

real <- data[1, 1:n, 1:30]
missing = real

prob_nan <- 0.3
set.seed(123)
mask <- runif(length(real)) < prob_nan
missing[mask] <- NaN

loc = lat_lon_alt[1:n, 1:2]
```

```{r}
real <- abind::abind(real, real, along = 2)   # 沿第2維(row)合併
missing <- abind::abind(missing, missing, along = 2)
loc <- rbind(loc)
```

```{r}
params <- list(
  data = missing,
  loc = loc,
  method = "EM"
)
```

```{r}
start_time <- Sys.time()
model_r <- autoFRK(
  data = params$data,
  loc = params$loc,
  method = params$method
)

pred_r <- predict(model_r)
end_time <- Sys.time()
```

```{r}
mse <- mean((pred_r$pred.value - real)**2)
mspe <- mean((pred_r$pred.value - real)**2 / real)
paste0("MSE: ", mse) %>% print()
paste0("MSPE: ", mspe) %>% print()
paste0("Time spend: ", end_time - start_time) %>% print()
```

